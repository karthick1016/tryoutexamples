<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>WebSocket</title>
		<style>
			#chatLog input{
				width: 70%;
				padding: 20px;
				border-radius: 5px;
				bottom: 50px;
				left: 105px;
				right: 100px;
			}
			#button{
				background-color: blue;
				color: white;
				font-size: 16px;
				width:50%;
				height:50px;
				border-radius:5px;
			}
			#chatLog button{
				position:fixed;
				width:100px;
				padding: 2px;
				border-radius: 5px;
				bottom: 55px;
				left: 85%;	
			}
			
		</style>
	</head>

	<body>
			<div id="chatLog">
				<form id="chatForm">
					<input id="chatMessage" placeholder="Type  message and press enter..." type="text">
					<button id="button" >send</button>
				</form>
			</div>
		<script>
			var userName = `user_${getRandomNumber()}`
			var apiKey = 'oCdCMcMPQpbvNjUIzqtvF1d2X2okWpDQj4AwARJuAgtjhzKxVEjQU6IdCjwm';
			var channelId = 2;
			var piesocket = new WebSocket(`wss://demo.piesocket.com/v3/${channelId}?api_key=${apiKey}&notify_self`);

			var chatLog = document.getElementById('chatLog');
			var chatForm = document.getElementById('chatForm');
			chatForm.addEventListener("submit", sendMessage);
			
			piesocket.onopen = function() {
				alert("Websocket connected");
				piesocket.send(JSON.stringify({
					event: 'new_joining',
					sender: username,
				}));
			}
			piesocket.onmessage = function(message) {
				var payload = JSON.parse(message.data);
				console.log(payload);
				//alert(payload.sender);
				if (payload.sender == userName) {
					payload.sender = "You";
				}

				if (payload.event == "new_message") {

					//Handle new message
					chatLog.insertAdjacentHTML('afterend', `<div>  ${payload.sender}: ${payload.text}<div>`);

				} else if (payload.event == 'new_joining') {

					//Handle new joining
					chatLog.insertAdjacentHTML('afterend', `<div> ${payload.sender} joined the chat<div>`);

				}
			}
			function getRandomNumber() {
				return Math.floor(Math.random() * 1000);
			}

			function sendMessage(event) {
				event.preventDefault();

				var message = document.getElementById('chatMessage').value;
				("Websocket connectedcdc");
				piesocket.send(JSON.stringify({
					event: 'new_message',
					sender: userName,
					text: message
				}));
			}
		</script>
	</body>
</html>